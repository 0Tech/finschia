#!/bin/sh

set -e

daemon=$1
[ -n "$daemon" ]

cosmovisor=$2
[ -n "$cosmovisor" ]

output=$3
[ -n "$output" ]

if [ "$(echo @CMAKE_BUILD_TYPE@ | awk '{print tolower($0)}')" = debug ]
then
	DEBUG=true
else
	DEBUG=false
fi

if [ $DEBUG = false ]
then
	exec 1>/dev/null 2>&1
fi

case @FIXTURE_DAEMON_VERSION@ in
	local|dummy)
		cp "$daemon" bundle.tar.gz
	;;
	*)
		# TODO: arch & os
		_version=@FIXTURE_DAEMON_VERSION@
		_workdir=$(mktemp -dp .)
		_artifact=@CMAKE_PROJECT_NAME@-v$_version-linux-amd64
		curl -Lo $_workdir/bundle.tar.gz @GITHUB_URL@/releases/download/v$_version/$_artifact.tgz
		sh -c "cd $_workdir && tar -xzf bundle.tar.gz && cd $_artifact && mv $_artifact @DAEMON_NAME@ && tar -czf ../../bundle.tar.gz *"
		rm -rf $_workdir
	;;
esac

cp "$cosmovisor" binaries/cosmovisor
docker build -t @PROJECT_NAME@:@FIXTURE_DAEMON_VERSION@ .

touch $output
